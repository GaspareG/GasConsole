<html>
	<head>
		<title>Game5</title>
		<style>
			body {
				margin: 0px ;
				padding: 0px ;
				background: #ccc ;
			}

			#canvas { 
				width: 1000px ;
				height: 500px ;
			}
		</style>
	</head>	
	<body>
		<canvas height="500px" width="1000px" id="canvas"></canvas>
		<script>

			// Variabili Globali
			var canvas   = document.getElementById("canvas");
			var ctx      = canvas.getContext("2d");
			var width    = 1000 ;
			var height   = 500 ;

			var maxd = 32;
			var stars = [] ;

			function randomRange(minVal,maxVal) {
      				return Math.floor(Math.random() * (maxVal - minVal - 1)) + minVal;
			}
 
			var cc = 25 ;
    			function initStars() {
      				for( var i = 0; i < 250; i++ ) {
        				stars[i] = {
          					x: randomRange(-cc*2,cc*2),
          					y: randomRange(-cc  ,cc  ),
          					z: randomRange(1,maxd),
						x0: 0,
						y0: 0
         				}
      				}
    			}
	
			initStars();

			var x = 0 ;
			var y = 0 ;	
			var velz = 0.2 ;

			var asteroids = [] ;
			var center = [width/2, height/2] ;

			function addAsteroide(rad,pos)		
			{
				var nuovo = [] ;
				nuovo.push( [pos[0]+rad,pos[1],pos[2]] );
                                nuovo.push( [pos[0],pos[1]-rad,pos[2]] );
                                nuovo.push( [pos[0]-rad,pos[1],pos[2]] );
				nuovo.push( [pos[0],pos[1]+rad,pos[2]] );
				return nuovo ;
			}
			
			function proietta(x,y,z)
			{
				var k  = 128.0 / z;
				return [x*k + center[0], y*k + center[1]] ;								
			}


			function trasla(x,y,z)
			{
				for(var i=0; i<stars.length; i++)
				{
					stars[i].x += x ;                                       
					stars[i].y += y ;
                                        stars[i].z += z ;
				}
				for(var i=0; i<asteroids.length; i++ )
				for(var j=0; j<asteroids[i].length; j++)
				{
					asteroids[i][j][0] += x ;
                                        asteroids[i][j][1] += y ;
                                        asteroids[i][j][2] += z ;
				}
			}


		
			document.addEventListener("DOMContentLoaded",function(){

				// Connessione WebSocket
                        	var wsServer = new WebSocket("ws://88.198.124.71:6060");
                        	var wsReady = false ;

                        	wsServer.onopen = function(){
                                	wsServer.send("SERVER");
       	                        	wsReady = true ;
	                        };

				// Parsing Input
				wsServer.onmessage = function(event){
					var data = JSON.parse(event.data);
					if( data.length >= 1 )
					{
						if( data[0].controller == "wheel" )
						{
							var direction = data[0].wheel.direction ;
							velz = direction.vel / 200 ;
							trasla(-( direction.deg )/50,0,0);
							
						}
					}		
				};
				
				// Refresh Gioco
				var update = setInterval(function(){

					var halfWidth  = canvas.width / 2;
				        var halfHeight = canvas.height / 2;
 	
   					ctx.fillStyle = "rgb(0,0,0)";
					ctx.fillRect(0,0,canvas.width,canvas.height);
 					var ok = 0 ;

					for( var i = 0 ; i < stars.length ; i++ )
					{

                                               	if( stars[i].z <= 0 ) 
                                               	{
                                                        stars[i].x = randomRange(-cc*2,cc*2);
                                                        stars[i].y = randomRange(-cc  ,cc  );
                                                        stars[i].z = maxd;
                                               	}
 
        					var pos = proietta(stars[i].x,stars[i].y,stars[i].z);
 
						var size = (1 - stars[i].z / 32.0) * 2;
						var shade = parseInt((1 - stars[i].z / 32.0) * 255);
						ctx.fillStyle = "rgb(" + shade + "," + shade + "," + shade + ")";
          					ctx.fillRect(pos[0], pos[1],size,size);

						if( pos[0] < 0 || pos[0] > width || pos[1] < 0 || pos[1] > height ){
                                                        stars[i].x = randomRange(-cc*2,cc*2);
                                                        stars[i].y = randomRange(-cc  ,cc  );
                                                        stars[i].z = maxd;
                                                }

					}

					for(var i=0; i<asteroids.length; i++)
  					{
						var neg = false ;
						  for(var j=0; j<asteroids[i].length; j++)
							if( asteroids[i][j][2] <= 0 )
							{
								neg = true ;
								break ;	
							}
						if(neg)
							asteroids[i] = addAsteroide(15, [randomRange(-cc*2,cc*2),randomRange(-cc,cc),maxd]);
					}

					for(var i=0; i<asteroids.length; i++)
					{
						var proiettati = [] ;
						for(var j=0; j<asteroids[i].length; j++)
							proiettati.push( proietta(asteroids[i][j][0], asteroids[i][j][1],  asteroids[i][j][2]) );

						ctx.beginPath();
						ctx.strokeStyle = "white" ;
						ctx.moveTo(proiettati[0][0],proiettati[0][1]);
						for(var j=1; j<proiettati.length; j++)
							ctx.lineTo(proiettati[j][0], proiettati[j][1]);
                                                ctx.lineTo(proiettati[0][0], proiettati[0][1]);
						ctx.stroke();
					}

					trasla(0,0,-velz);					
				},35);
		
				asteroids.push(addAsteroide(20,[0,0,maxd]));
				asteroids.push(addAsteroide(20,[50,0,maxd]));
				asteroids.push(addAsteroide(20,[-50,0,maxd]));
			});				


		</script>
	</body>
</html>
