<html>
	<head>
		<title>Game4</title>
		<style>
			body {
				margin: 0px ;
				padding: 0px ;
				background: #ccc ;
			}

			#canvas { 
				width: 1000px ;
				height: 500px ;
			}
		</style>
	</head>	
	<body>
		<canvas height="500px" width="1000px" id="canvas"></canvas>
		<script>

			// Variabili Globali
			var canvas   = document.getElementById("canvas");
			var ctx      = canvas.getContext("2d");
			var width    = 1000 ;
			var height   = 500 ;

			var bSize   = [25,25] ;
			var pos     = [1,8] ;
			var frame   = 0 ;		
	
			var player  = false ;
			var offline = false ;
			var point   = 0 ;
			var morto   = false ;
			var vinto   = false ;

			var vite    = 3 ;
			var livello = [
				[3,1, 1,1, 1,1, 1,1, 1,1, 1,1, 1,1, 1,1, 1,14,1, 4],
                                [2,9, 9,9, 9,9, 9,9, 9,9, 9,9, 9,9, 9,9, 9,11,9, 2],
                                [2,9, 3,8, 9,7, 1,1, 8,9, 7,8, 9,7, 8,9,12, 9,9, 2],
                                [2,9, 2,9, 9,9, 9,9, 9,9, 9,9, 9,9, 9,9, 9, 9,7,13],
                                [2,9,11,9,10,9, 3,1, 4,9,10,9,10,9,10,9,10, 9,9, 2],
                                [2,9, 9,9,11,9,11,9,11,9, 5,1, 6,9,11,9, 2, 9,7,13],
                                [2,9,10,9, 9,9, 9,9, 9,9, 9,9, 9,9, 9,9, 2, 9,9, 2],
                                [2,9, 5,8, 9,7, 1,1, 8,9, 7,8, 9,7, 8,9, 5, 8,9, 2],
                                [2,0, 9,9, 9,9, 9,9, 9,9, 9,9, 9,9, 9,9, 9, 9,9, 2],
                                [5,1, 1,1, 1,1, 1,1, 1,1, 1,1, 1,1, 1,1, 1, 1,1, 6]
			] ;

	
			document.addEventListener("DOMContentLoaded",function(){

				// Connessione WebSocket
                        	var wsServer = new WebSocket("ws://88.198.124.71:6060");
                        	var wsReady = false ;

                        	wsServer.onopen = function(){
                                	wsServer.send("SERVER");
       	                        	wsReady = true ;
	                        };

				// Parsing Input
				wsServer.onmessage = function(event){
					var data = JSON.parse(event.data);
					player  = false ;
					offline = false ;
					
					if( data.length >= 1 )
					{
						player = true ;
						if(data[0].offline)
						{
							offline = true ;
							return ;	
						}
						if( morto ) return ;
						switch(data[0].controller)
						{
							case "wheel":
								var deg = data[0].wheel.direction.deg;
								if( Math.abs(deg) > 15 )
									pos += Math.sin(deg*Math.PI/180)*4 ;
							break ;
							case "analog":
								var analog = data[0].analog ;
								if( analog.left.perc != 0 )
								{
									angle = analog.left.deg-90;
                                                                        pos += Math.sin(angle*Math.PI/180)*analog.left.perc/25 ;
								}
							break ;
							case "classic":
								var direction = data[0].classic.direction;
								if( direction.left ){
									pos -= 4 ;
								} else if( direction.right ){
									pos += 4 ;
								}

							break;
						}
                                               
						pos = Math.min(100,Math.max(0,pos));
					}									
				};
				
				// Refresh Gioco
				var update = setInterval(function(){

					// Pulisco 
					ctx.fillStyle = "#000";
 					ctx.fillRect(0,0,width,height);

					// Stili 
					ctx.fillStyle = "white" ;
					ctx.strokeStyle = "white" ;
					ctx.lineWidth = 3 ;

					// Cursore Giocatore
					frame++ ;
					var add = Math.abs(Math.sin(10*frame*Math.PI/180))/2 ;

					ctx.fillStyle = "#EEFF41" ;
					ctx.beginPath();
					ctx.arc(pos[0]*50+25, pos[1]*50+25,25, add+0.25*Math.PI-Math.PI/8, add+1.25 * Math.PI - Math.PI/8, false);
					ctx.fill();
					ctx.beginPath();
					ctx.arc(pos[0]*50+25, pos[1]*50+25,25, 0.75 * Math.PI -add + Math.PI/8, 1.75 * Math.PI -add + Math.PI/8, false);
					ctx.fill();

					// Livello
					for(var i=0; i<livello.length; i++)
					{
						var tw = width/livello[i].length ;
						var th = height/livello.length ;
						for(var j=0; j<livello[i].length; j++)
						{
							if( !livello[i][j] ) continue ;
							var x = tw*j+tw/2 ;
							var y = th*i+th/2 ;
							switch( livello[i][j] )
							{
								case 1:
									ctx.fillStyle = "#1E88E5" ;
									ctx.fillRect(x-tw/2, y-th/4, tw, th/2);
								break;
								case 2:
                                                                        ctx.fillStyle = "#1E88E5" ;
                                                                        ctx.fillRect(x-tw/4, y-th/2, tw/2, th);
								break ;					
                                                                case 3:
                                                                        ctx.fillStyle = "#1E88E5" ;
                                                                        ctx.fillRect(x-tw/4, y, tw/2, th/2);
                                                                        ctx.fillRect(x, y-th/4, tw/2, th/2);
                                                                        ctx.beginPath();
                                                                        ctx.arc(x,y, tw/4, 0, Math.PI*2);
                                                                        ctx.fill();
                                                                break ;         		
                                                                case 4:
                                                                        ctx.fillStyle = "#1E88E5" ;
                                                                        ctx.fillRect(x-tw/4, y, tw/2, th/2);
                                                                        ctx.fillRect(x-tw/2, y-th/4, tw/2, th/2);
                                                                        ctx.beginPath();
                                                                        ctx.arc(x,y, tw/4, 0, Math.PI*2);
                                                                        ctx.fill();
                                                                break ;
                                                                case 5:
                                                                        ctx.fillStyle = "#1E88E5" ;
                                                                        ctx.fillRect(x-tw/4, y-th/2, tw/2, th/2);
                                                                        ctx.fillRect(x, y-th/4, tw/2, th/2);
									ctx.beginPath();
									ctx.arc(x,y, tw/4, 0, Math.PI*2);
									ctx.fill();
                                                                break ;
                                                                case 6:
                                                                        ctx.fillStyle = "#1E88E5" ;
                                                                        ctx.fillRect(x-tw/4, y-th/2, tw/2, th/2);
                                                                        ctx.fillRect(x-tw/2, y-th/4, tw/2, th/2);
                                                                        ctx.beginPath();
                                                                        ctx.arc(x,y, tw/4, 0, Math.PI*2);
                                                                        ctx.fill();
                                                                break ;		
                                                                case 7:
                                                                        ctx.fillStyle = "#1E88E5" ;
                                                                        ctx.fillRect(x, y-th/4, tw/2, th/2);
                                                                        ctx.beginPath();
                                                                        ctx.arc(x,y, tw/4, 0, Math.PI*2);
                                                                        ctx.fill();
                                                                break ;         
                                                                case 8:
                                                                        ctx.fillStyle = "#1E88E5" ;
                                                                        ctx.fillRect(x-tw/2, y-th/4, tw/2, th/2);
                                                                        ctx.beginPath();
                                                                        ctx.arc(x,y, tw/4, 0, Math.PI*2);
                                                                        ctx.fill();
                                                                break ;         

                                                                case 10:
                                                                        ctx.fillStyle = "#1E88E5" ;
                                                                        ctx.fillRect(x-tw/4, y, tw/2, th/2);
                                                                        ctx.beginPath();
                                                                        ctx.arc(x,y, tw/4, 0, Math.PI*2);
                                                                        ctx.fill();
                                                                break ;         
                                                                case 11:
                                                                        ctx.fillStyle = "#1E88E5" ;
                                                                        ctx.fillRect(x-tw/4, y-th/2, tw/2, th/2);
                                                                        ctx.beginPath();
                                                                        ctx.arc(x,y, tw/4, 0, Math.PI*2);
                                                                        ctx.fill();
                                                                break ;        
                                                                case 12:
                                                                        ctx.fillStyle = "#1E88E5" ;
                                                                        ctx.beginPath();
                                                                        ctx.arc(x,y, tw/4, 0, Math.PI*2);
                                                                        ctx.fill();
                                                                break ;         
                                                                case 13:
                                                                        ctx.fillStyle = "#1E88E5" ;
                                                                        ctx.fillRect(x-tw  , y-th/4, tw, th/2);
									ctx.fillRect(x-tw/4, y-th/2, tw/2, th);
                                                                break ;
                                                                case 14:
                                                                        ctx.fillStyle = "#1E88E5" ;
									ctx.fillRect(x-tw/4, y     , tw/2, th);
                                                                        ctx.fillRect(x-tw/2, y-th/4, tw, th/2);
                                                                break;
								case 9:
									ctx.fillStyle = "#FFF9C4" ;
									ctx.beginPath();
									ctx.arc(tw*j+tw/2, th*i+th/2, tw/10, 0, Math.PI*2);
									ctx.fill();
								break ;
							}
						}						
					}

                                        // Punti
                                        ctx.font = "50px Arial" ;
					ctx.fillStyle = "white" ;
                                        ctx.textAlign = "right" ;
                                        ctx.fillText(point, width-10,50);

                                        // Vite
                                        ctx.fillStyle = "#D50000" ;

                                        for(var i=0; i<vite ; i++)
                                        {
                                                var x = 35+i*35;
                                                var y = 10 ;
                                                ctx.beginPath();
                                                ctx.moveTo(x+20,y+30);
                                                ctx.lineTo(x+32,y+10);
                                                ctx.lineTo(x+8,y+10);
                                                ctx.fill();     
                                                ctx.beginPath();
                                                ctx.arc(x+14,y+10,6,Math.PI,2*Math.PI);
                                                ctx.fill();
                                                ctx.beginPath();
                                                ctx.arc(x+26,y+10,6,Math.PI,2*Math.PI);
                                                ctx.fill();
                                        }
				
					return ;

					// Wait player
					if( !player )
					{
						ctx.fillStyle = "rgba(0,0,0,0.5)";
						ctx.fillRect(0,0,width,height);
		                                ctx.font = "50px Arial" ;
	                                        ctx.textAlign = "center" ;
						ctx.fillStyle = "white" ;
        	                                ctx.fillText("Waiting for Player!", width/2,height/2);
						return;
					} 
					
					// Offline player
					if( offline )
					{
                                                ctx.fillStyle = "rgba(0,0,0,0.5)";
                                                ctx.fillRect(0,0,width,height);
                                                ctx.font = "50px Arial" ;
                                                ctx.textAlign = "center" ;
                                                ctx.fillStyle = "white" ;
                                                ctx.fillText("Player offline!", width/2,height/2);
                                                return;
					}	

                                        // Morto player
                                        if( morto )
                                        {
                                                ctx.fillStyle = "rgba(0,0,0,0.5)";
                                                ctx.fillRect(0,0,width,height);
                                                ctx.font = "50px Arial" ;
                                                ctx.textAlign = "center" ;
                                                ctx.fillStyle = "white" ;
                                                ctx.fillText("You are dead!", width/2,height/2);
						ctx.font = "40px Arial" ;
						ctx.fillText(point + " Points",width/2,height/2+60);	
                                                return;
                                        }  

                                        // Vinto player
                                        if( vinto )
                                        {
                                                ctx.fillStyle = "rgba(0,0,0,0.5)";
                                                ctx.fillRect(0,0,width,height);
                                                ctx.font = "50px Arial" ;
                                                ctx.textAlign = "center" ;
                                                ctx.fillStyle = "white" ;
                                                ctx.fillText("You Win!", width/2,height/2);
                                                ctx.font = "40px Arial" ;
                                                ctx.fillText(point + " Points",width/2,height/2+60);    
                                                return;
                                        }  

					// Game!!				



				},35);
		
			});				
		</script>
	</body>
</html>
