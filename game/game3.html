<html>
	<head>
		<title>Game3</title>
		<style>
			body {
				margin: 0px ;
				padding: 0px ;
				background: #ccc ;
			}

			#canvas { 
				width: 1000px ;
				height: 500px ;
			}
		</style>
	</head>	
	<body>
		<canvas height="500px" width="1000px" id="canvas"></canvas>
		<script>

			// Variabili Globali
			var canvas   = document.getElementById("canvas");
			var ctx      = canvas.getContext("2d");
			var width    = 1000 ;
			var height   = 500 ;

			var position = [width/2,height/2];
			var angle    = 0;
			var curDim   = [20,40]; // w/h

			var player  = false ;
			var offline = false ;
			var point   = 0 ;

			var asteroids = [] ;
			
			function addAsteroids(aRad,aPos)
			{
				var nuovo = { center: aPos, points: [], vel: [], radius: aRad };
				nuovo.vel[0] = Math.random()*12-6;
				nuovo.vel[1] = Math.random()*12-6;

				var punti = 2*parseInt(3+Math.random()*3);
				for(var i=0; i<punti; i++)
				{
					var angolo = 360/punti*i ;
					var distanza = aRad/2 + (aRad/2*Math.random());
					nuovo.points.push([ Math.sin(angolo*Math.PI/180)*distanza, 
						      Math.cos(angolo*Math.PI/180)*distanza ]);
				}
				asteroids.push(nuovo);
			}


			addAsteroids(40,[200,250]);

			document.addEventListener("DOMContentLoaded",function(){

				// Connessione WebSocket
                        	var wsServer = new WebSocket("ws://88.198.124.71:6060");
                        	var wsReady = false ;

                        	wsServer.onopen = function(){
                                	wsServer.send("SERVER");
       	                        	wsReady = true ;
	                        };

				// Parsing Input
				wsServer.onmessage = function(event){
					var data = JSON.parse(event.data);
					player  = false ;
					offline = false ;
					if( data.length >= 1 )
					{
						player = true ;
						if(data[0].offline)
						{
							offline = true ;
							return ;	
						}

						switch(data[0].controller)
						{
							case "wheel":
								var deg = data[0].wheel.direction.deg;
								var vel = data[0].wheel.direction.vel;
								if( deg <= -15 || deg >= 15 )
								{
									angle += deg/10 ;
									console.log(deg, Math.sin(deg*Math.PI/180)*vel );
								}
				
								if( vel >= 45 )
								{
									position[0] += Math.sin(angle*Math.PI/180)*vel/10 ;
									position[1] -= Math.cos(angle*Math.PI/180)*vel/10 ;
								}
							break ;
							case "analog":
								var analog = data[0].analog ;
								if( analog.left.perc != 0 )
								{
									angle = analog.left.deg-90;
                                                                        position[0] += Math.sin(angle*Math.PI/180)*analog.left.perc/15 ;
                                                                        position[1] -= Math.cos(angle*Math.PI/180)*analog.left.perc/15 ;
								}
							break ;
							case "classic":
								var direction = data[0].classic.direction;
								if( direction.left ){
									position[0] -= 7 ;
									angle = 270 ;
								} else if( direction.right ){
									position[0] += 7 ;
									angle = 90 ;
								}
                                                                if( direction.top ){
                                                                        position[1] -= 7 ;
									angle = 0 ;
                                                                } else if( direction.down ){
                                                                        position[1] += 7 ;
									angle = 180 ;
                                                                }


							break;
						}
                                               
						if( position[0] >= 1000+40 )
                                                	position[0] = 0 ;
                                                if( position[1] >= 500+40 )
                                                	position[1] = 0 ;

						if( position[0] <= -40 )
                                                	position[0] = 1000 ; 
                                                if( position[1] <= -40 )
                                                	position[1] = 500 ;

				
					}									
				};
				
				// Refresh Gioco
				var update = setInterval(function(){

					// Pulisco 
					ctx.fillStyle = "black";
 					ctx.fillRect(0,0,width,height);

					// Stili 
					ctx.fillStyle = "white" ;
					ctx.strokeStyle = "white" ;
					ctx.lineWidth = 3 ;

					// Punti
					ctx.font = "50px Arial" ;
					ctx.textAlign = "center" ;
					ctx.fillText(point, width-75,75);
		
					// Cursore Giocatore
					ctx.save();
					ctx.beginPath();
					ctx.translate(position[0],position[1]);
					ctx.rotate(angle*Math.PI/180);
					ctx.moveTo(0           , -curDim[1]/2);
					ctx.lineTo(-curDim[0]/2, +curDim[1]/2);
                                       	ctx.lineTo(0           , +curDim[1]/3);
					ctx.lineTo(+curDim[0]/2, +curDim[1]/2);
                                        ctx.lineTo(0           , -curDim[1]/2);
					ctx.stroke();
					ctx.restore();
			
					// Wait player
					if( !player )
					{
						ctx.fillStyle = "rgba(0,0,0,0.5)";
						ctx.fillRect(0,0,width,height);
		                                ctx.font = "50px Arial" ;
	                                        ctx.textAlign = "center" ;
						ctx.fillStyle = "white" ;
        	                                ctx.fillText("Waiting for Player!", width/2,height/2);
						return;
					} 

					// Offline player
					if( offline )
					{
                                                ctx.fillStyle = "rgba(0,0,0,0.5)";
                                                ctx.fillRect(0,0,width,height);
                                                ctx.font = "50px Arial" ;
                                                ctx.textAlign = "center" ;
                                                ctx.fillStyle = "white" ;
                                                ctx.fillText("Player offline!", width/2,height/2);
                                                return;
					}	

					// Game!!				

					// Asteroids muovo
					for(var i=0; i<asteroids.length; i++)
					{
						asteroids[i].center[0] += asteroids[i].vel[0] ;
						asteroids[i].center[1] += asteroids[i].vel[1] ;
						if( asteroids[i].center[0] < -asteroids[i].radius )
							asteroids[i].center[0] = width ;
						else if( asteroids[i].center[0] - asteroids[i].radius >= width )
							asteroids[i].center[0] = -asteroids[i].radius ;
                                                if( asteroids[i].center[1] < -asteroids[i].radius )
                                                        asteroids[i].center[1] = height ;
                                                else if( asteroids[i].center[1] - asteroids[i].radius >= height )
                                                        asteroids[i].center[1] = -asteroids[i].radius ;

					}

					// Asteroids disegno
					for(var i=0; i < asteroids.length; i++)
					{
						ctx.beginPath();
						ctx.save();
						ctx.translate(asteroids[i].center[0], asteroids[i].center[1]);                                      
						ctx.moveTo(asteroids[i].points[0][0],asteroids[i].points[0][1]);
						for(var j=1; j<asteroids[i].points.length; j++)
	                                               ctx.lineTo(asteroids[i].points[j][0],asteroids[i].points[j][1]);
                                                ctx.lineTo(asteroids[i].points[0][0],asteroids[i].points[0][1]);
						ctx.stroke();
						ctx.restore();
					}

				},35);
		
			});				
		</script>
	</body>
</html>
